{% extends "base.html" %} {% load static %} {% block title %} Queues {% endblock title %} {% block content %}
<div class="content-wrapper">
  <div class="content">
    <!-- Card Profile -->

    <div class="row page-titleall">
      <div class="col-sm-8">
        <h2 class="page-title"><span>Queues</span></h2>
      </div>

      {% if user.role == "Super Admin" or user.role == "Admin" %}
      <div class="col-sm-4 text-right">
        <a
          class="btn btn-primary btn-pill"
          href="/queues/create"
          role="button"
        >
          Add Queue
        </a>
      </div>
      {% endif %}

    </div>
    <div class="row">
      <div class="col-12">
        <div class="card card-default">
          <div class="card-body">
            <table
              id="productsTable"
              class="table table-striped table-product"
              style="width: 100%"
            >
              <thead>
                <tr>
                  <th>#</th>
                  <th>Queue Name</th>
                  <th>Website</th>
                  <th>User</th>
                  <th>Edit/Delete</th>
                </tr>
              </thead>
              <tbody>
                {% for q in queues %}
                <tr>
                  <td class="py-0">{{ forloop.counter }}</td>
                  <td>{{ q.name }}</td>
                  <td>
                    <form method="post" action="/update-queue-website" class="input-group w-75">
                        {% csrf_token %}
                        <input
                            type="text"
                            class="form-control"
                            placeholder="Website"
                            aria-label="Website"
                            aria-describedby="btn-{{ forloop.counter }}"
                            required
                            id="websiteField-{{ forloop.counter }}"
                            name="website"
                            {% for uq in queues_users %}
                                {% if uq.queue.id == q.id %}
                                    value="{{ uq.website }}"
                                {% endif %}
                            {% endfor %}
                        />
                        <input
                            type="text"
                            name="user_queue"
                            {% for uq in queues_users %}
                                {% if uq.queue.id == q.id %}
                                    value="{{ uq.id }}"
                                {% endif %}
                            {% endfor %}
                            hidden
                        />

                        <div class="input-group-append">
                          <button type="submit" class="btn btn-dark" id="btn-{{ forloop.counter }}">Save</button>
                        </div>
                    </form>
                  </td>
                  <td>
                    <select class="form-control" id="queueUser-{{ forloop.counter }}">
                      <option></option>

                      {% for u in users %}
                        <option
                            value="{{ u.id }}"
                            data-url="/queues/assign/{{q.id}}/{{u.id}}"

                            {% for uq in queues_users %}
                                {% if uq.user.id == u.id and uq.queue.id == q.id %}
                                  selected
                                {% endif %}
                            {% endfor %}

                        >
                            {{u.username}}
                        </option>
                      {% endfor %}

                    </select>
                  </td>
                  <td>
                    {% if user.role == "Super Admin" or user.role == "Admin" %}
                    <a href="/queues/{{ q.id }}/update" class="btn btn-warning iconbtn"
                      ><i class="mdi mdi-account-edit"></i
                    ></a>
                    <a href="/queues/{{ q.id }}/delete" class="btn btn-danger iconbtn"
                      ><i class="mdi mdi-delete"></i
                    ></a>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
    const queuesUser = document.querySelectorAll('[id^="queueUser-"]');
    for (let q = 0; q < queuesUser.length; q++) {
        let queueUser = queuesUser[q];
        queueUser.addEventListener('change', function() {
          const selectedOption = this.options[this.selectedIndex];
          if (selectedOption.value && selectedOption.getAttribute('data-url')) {
            const url = selectedOption.getAttribute('data-url');
            window.location.href = url;
          }
        });

    }

    const websiteFields = document.querySelectorAll('[id^="websiteField-"]');
    for (let w = 0; w < websiteFields.length; w++) {
        let websiteField = websiteFields[w];
        let queueUser = document.getElementById(`queueUser-${parseInt(w) + 1}`);
        if (!queueUser || queueUser.value === "") {
            websiteField.disabled = true;
        } else {
            websiteField.disabled = false;
        }
    }

  </script>
{% endblock content %}
