{% extends "base.html" %} {% load static %} {% block title %} Task {% endblock title %} {% block content %}
<div class="content-wrapper">
  <div class="content">
    <div class="row page-titleall">
      <div class="col-sm-8">
        <h2 class="page-title"><span>Tasks</span></h2>
      </div>
    </div>

    {% if form.errors %}
      <div class="alert alert-danger">
        <strong>Error(s):</strong>
        {{ form.errors }}
      </div>
    {% endif %}

    <div class="row">
      <div class="col-xl-12">
        <!-- Form Square -->
        <div class="card card-default">
          <div class="card-header"></div>
          <div class="card-body">
            <form method="post">
              {% csrf_token %}
              <div class="form-group">
                <label for="exampleFormControlInput44">Task Name</label>
                {{ form.name }}
              </div>

              <div class="form-group">
                <label for="exampleFormControlPasswor3">Task Description</label>
                {{ form.description }}
              </div>

              <div class="row">
                <div class="form-group col-6">
                  <label for="exampleFormControlPasswor3">Due Date</label>
                  <div class=" d-flex justify-content-between align-items-end" id="due_date">
                    {{ form.due_date }}
                  </div>
                </div>

                <div class="form-group col-6" id="to_user_container">
                  <label for="exampleFormControlPasswor3">Assign To</label>
                  <input type="text" name="username" class="form-control" required="" id="id_to_user">
                </div>
              </div>

              <input type="text" name="from_user" value="{{ user.id }}" hidden>
              <div class="form-footer text-right mt-5">
                <button type="submit" class="btn btn-secondary btn-pill">
                  Assign task
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
  // edit due_date form
  const due_date_container = document.getElementById("due_date");
  const day_field = document.getElementById("id_due_date_day");
  const month_field = document.getElementById("id_due_date_month");
  const year_field = document.getElementById("id_due_date_year");

  day_field.className = "form-control ";
  month_field.className = "form-control mx-1";
  year_field.className = "form-control ";

  due_date_container.innerHTML = `
    ${day_field.outerHTML}
    ${month_field.outerHTML}
    ${year_field.outerHTML}
    `;
</script>

<!-- Search Field -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    let userInput = document.getElementById("id_to_user");
    let userContainer = document.getElementById("to_user_container");
    let dropdown;

    userInput.addEventListener("focus", function () {
      // Simulate fetching user data (replace this with your actual endpoint)
      let userData = "";

      // Create a dropdown element
      dropdown = document.createElement("div");
      dropdown.className =
        "dropdown d-block position-absolute bg-dark w-100 text-light p-1";
      dropdown.style.zIndex = 10000;
      userInput.placeholder = "Search for an employee";

      userInput.addEventListener("input", function () {
        let searchTerm = userInput.value.toLowerCase();

        // Make an AJAX request to the Django view
        fetch("/user-search/?search_term=" + searchTerm)
          .then((response) => response.json())
          .then((data) => {
            // Update the dropdown with the fetched data
            updateDropdown(data.employees);
          });
      });

      // Create a list to display user options
      let userList = document.createElement("ul");
      userList.className = "user-list";

      // Append elements to the dropdown
      dropdown.appendChild(userList);

      // Append the dropdown to the body
      userContainer.appendChild(dropdown);

      // Add users to the list
      fetch("/user-search/")
        .then((response) => response.json())
        .then((data) => {
          // Update the dropdown with the fetched data
          updateDropdown(data.employees);
        });

      // Close the dropdown when clicking outside of it
      document.addEventListener("click", function (event) {
        if (
          !dropdown.contains(event.target) &&
          event.target !== userInput
        ) {
          dropdown.remove();
        }
      });
    });

    function updateDropdown(users) {
      let userList = document.querySelector(".user-list");
      userList.innerHTML = ""; // Clear existing options

      // Create and append user options to the list
      users.forEach(function (user) {
        let listItem = document.createElement("li");
        listItem.className = "searchFieldDropdownItem";
        listItem.textContent = user.username;

        // Handle user selection
        listItem.addEventListener("click", function () {
          userInput.value = user.username;
          dropdown.remove();
        });

        userList.appendChild(listItem);
      });
    }
  });
</script>

{% endblock content %}
